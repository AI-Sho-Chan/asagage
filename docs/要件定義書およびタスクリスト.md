要件定義書およびタスクリスト


1. 目的・概要

目的: 「Project Asagake (Morning Rush)」において、寄り付き直後の逆張りスキャルピング戦略を支援するシステムを、PythonとExcelのハイブリッド構成で実現する。高速な全銘柄スクリーニング処理をPythonで担い、トレーダーが直感的に判断できるUIをExcelで提供することで、開発効率と実運用効果を高めることが目的である。その上で、本変更では当初の単一Pythonアプリ構成からアーキテクチャを刷新し、戦略ロジック自体は維持しつつ実装形態を最適化する。

概要: システムは2つのコンポーネントで構成される。

Python製「銘柄スクリーナー」(Component A) – 寄り付き前に全市場の板情報を高速スキャンし、条件を満たす銘柄リストを生成する役割（システムの頭脳部分）。

Excel製「監視コックピット」(Component B) – Pythonから渡された候補銘柄について、寄り付き後のリアルタイム指標を表示・監視し、トレーダーの判断材料を提供する役割（システムの操縦席）。

このハイブリッド構成により、

適材適所の処理: 重たいスクリーニング計算はPythonの高速処理に任せ、ユーザーインターフェースや裁量判断支援はExcelの優れた可視化機能に委ねる。
e-debugger.xyz

開発・運用効率: Pythonで一からGUI開発する手間を省き、既存のExcel環境を活用することで迅速なシステム稼働を目指す。

判断精度向上: Excel上で複数銘柄の状況を一覧比較できるダッシュボードを提供し、単一銘柄通知よりも文脈を持った判断（エントリー是非や取引戦略の比較）が可能になる。

将来的な自動発注機能の追加も視野に入れており、現在の構成はあくまでトレーダーの判断を支援する半自動システムだが、後述するように拡張性に配慮した設計とする。

2. 新アーキテクチャの全体像

新アーキテクチャでは、明確に役割分担された2コンポーネントが連携動作します。以下に各コンポーネントの詳細を示します。

2.1 Component A: Python銘柄スクリーナー – 寄り付き前の高速スクリーニング担当（システムの頭脳）

役割: 東証プライム全銘柄を対象に、寄り付き前（8:55～8:59頃）の板情報を監視し、本日の逆張りスキャルピング候補となる銘柄を抽出する。

処理時間帯: 毎営業日 8:55:00～8:59:50 JSTに動作。市場開始直前の板気配を分析対象とする。

データソース: auカブコム証券 kabuステーション® API を使用し、板情報（気配値・気配数量など）および前日終値等を取得。

出力: 指定時刻（概ね8:59:50）時点で条件合致した銘柄コードのリストを生成。リストは人間がコピーしやすい形式でコンソール表示するとともに、watchlist.txt 等のテキストファイルにも保存する。例:

['7203', '9984', '6758']


※銘柄コードは文字列4桁+市場識別子（必要に応じて）の形式。上記例は東証プライムのトヨタ(7203)、ソフトバンクG(9984)、ソニー(6758)を示す。

留意点（性能と信頼性）: 全銘柄データ取得にはAPIコールが集中するため、マルチスレッド処理やWebSocketの活用による高速化、取得対象銘柄の絞り込み（必要なら事前に流動性でフィルタリング）などで5分以内の完了を保証すること
how-to-make-stock-trading-system.dogwood008.com
。また、API障害時のリトライやログ出力、非営業日のスキップ等、堅牢性にも配慮する。

2.2 Component B: Excel監視コックピット – 寄り付き後のリアルタイム監視担当（システムの操縦席）

役割: Component Aが抽出した少数の候補銘柄について、マーケット開始直後の価格推移やテクニカル指標をリアルタイムにモニタリングし、エントリー機会を可視化する。トレーダーはこのコックピット画面を見て裁量判断を下す。

処理時間帯: 毎営業日 9:00:00～9:15:00 JST頃まで動作。寄り付き直後の数分～15分程度を想定（以降は当日の戦略終了または別システムへ移行）。

データソース: 楽天証券 マーケットスピード II (MarketSpeed II) RSS 機能を利用し、Excel上でリアルタイム株価・指標データを取得する。マーケットスピードIIを起動しログインした状態で、Excelに提供されるRSS関数を介してデータ更新。

インプット: Pythonスクリーナーから得た銘柄コードのリストをExcelシートに手動または自動で入力する。手動の場合は8:59～9:01の間にトレーダーが数件のコードをコピーペーストする運用。可能であればExcelがテキストファイルwatchlist.txtを参照して自動読み込みする仕組みでも良い。

アウトプット/表示: Excelシート上に、各候補銘柄のリアルタイムデータおよび計算指標を一覧表示する。条件を満たした際には視覚的アラート（セルの色変更や点滅）で通知。併せて、エントリー判断に役立つ目標利確価格・損切価格の目安も自動計算され、シート上に表示される。

2.3 運用ワークフロー概要:

08:55 – Pythonスクリーナー（Component A）が自動起動し、東証プライム全銘柄の板情報スキャン開始。10秒おき程度に板データを取得しつつ、各銘柄の指標を計算。

08:59:50 – スクリーナーがスキャンを終了し、条件を満たした監視対象銘柄のリストを生成。結果をコンソール表示するとともにファイルに書き出し、自動でプロセス終了。

09:00～09:01 – トレーダーがExcelコックピットを開き、Python出力の銘柄コードを入力（手動ペースト or 自動読み込み）。マーケットスピードII（RSS）がExcelと接続され、データ取得を開始。

09:01～09:15 – Excelコックピット（Component B）が指定銘柄のリアルタイム情報を更新表示。AVWAP・ATR・乖離率等を計算しつつ監視を継続。シグナル条件（後述）を満たせばセルの色を変えて注意喚起。

トレーダー判断・発注: トレーダーはExcel上の情報を参考にエントリー判断を行い、条件良好と見ればマーケットスピードIIの発注ツールや他の取引端末で手動発注する（本仕様では自動発注は実施しない）。判断に迷う場合は見送り、9:15以降は当日の本戦略をクローズ。

将来拡張: もし自動発注を行う場合は、Excel側で閾値到達を検知したタイミングでVBA経由の発注関数を呼ぶか、またはPython側でExcelと同様のロジックを実装してAPI発注する形に発展させる。現段階では手動に留め、今後の拡張課題とする。

3. 機能要件（Functional Requirements）

上記アーキテクチャに基づき、各コンポーネントに求められる機能要件（FR）を定義します。Ver.2.0提案書の内容を踏まえつつ、必要な修正・追加事項を反映しています。

【Component A: Pythonスクリーナーの機能要件】

FR-A-1: データ取得 – kabuステーション® APIを用い、東証プライム市場全銘柄の寄り付き前板情報を取得する。取得項目は最低限気配値（最良買気配値・最良売気配値）および気配数量（最良気配の出来高）、必要に応じて前日終値や出来高など戦略に必要なデータ。取得間隔はおおむね10秒ごととし、8:55:00から8:59:50までループ処理を行うこと。APIコール回数が膨大になるため、並列処理やサブスクライブ機能の活用、あるいは事前選別による対象縮小で制限時間内に全銘柄をカバーする
how-to-make-stock-trading-system.dogwood008.com
。取得した各銘柄データはメモリ上に保持し、後続の指標計算に供する。

FR-A-2: 銘柄選定ロジック – AOI指標に基づき監視銘柄をスクリーニングするロジックを実装する。具体的には以下のとおり:

FR-A-2.1: スクリーナーは毎営業日8:55:00 JSTに自動起動する（APScheduler等のジョブスケジューラを使用）。非営業日には起動しない、または即座に終了する仕組みとする。

FR-A-2.2: APIから取得した板情報を用いて、各銘柄の**AOI (板のAsk/Bidのオーダーインバランス等)をリアルタイム計算すること。※AOIの定義については「（買気配数量－売気配数量）／（買気配数量＋売気配数量）」**など想定。具体的な計算式はプロジェクトドキュメントに従うこと（不明な場合は要確認）。

FR-A-2.3: 8:55から取得した各銘柄AOIの時系列データ（約30ポイント程度）を保持し、その標準偏差を算出すること。標準偏差が小さいほどAOIが安定（時間経過で値がブレていない）とみなす。安定性評価の定量基準（例えば標準偏差が一定値以下等）は、過去データ分析に基づき適切に設定する。

FR-A-2.4: 8:59:50 JST 時点で各銘柄の最新AOI値および安定性を評価し、選定条件「|AOI| ≥ 0.4 かつ AOIの安定性が高い」を満たす銘柄を抽出すること。ここで0.4は閾値の例であり、必要に応じて調整可能とする。また、符号（プラス/マイナス）は逆張り方向（プラスAOIは売りシグナル候補、マイナスAOIは買い候補）を示すものと想定する。

FR-A-2.5: 抽出した銘柄コードのリストを人間が容易に利用できる形式で出力すること。具体的にはPythonのコンソール標準出力に上記【2.1 出力】の形式で表示し、加えて同内容をテキストファイルに書き込む。出力後、スクリーナープロセスはただちに終了し、以降のリアルタイム監視はExcelに委ねる。

FR-A-2.6: （追加要件）万一抽出銘柄が0件だった場合の扱いについて定めること。基本方針としては、「該当銘柄なし」の旨を出力し、Excel側では空欄または「なし」と表示する運用とする。また抽出数が多すぎる（10銘柄超など）場合は、上位数銘柄（例えば乖離絶対値の大きい順に上位5～10件）に絞って出力すること。これによりExcelコックピットでの収容範囲内に収める。

FR-A-2.7: （追加要件）当日のスクリーニング結果や処理ログをログファイルに記録すること。銘柄数や処理時間、エラー発生時の情報を保存し、検証や戦略改善に役立てる。ログには日付を付与し、過去分も一定期間保管する。

FR-A-3: エラー処理と終了処理 – 安定した無人稼働を実現するため、以下を満たす:

FR-A-3.1: API接続エラーやデータ取得失敗時には一定回数リトライを行うこと（例：3回までリトライし、それでも失敗なら該当銘柄をスキップしてログ記録）。

FR-A-3.2: 想定外の例外発生時にはスクリプトがクラッシュしないようtry-exceptでハンドリングし、エラーメッセージをログ出力する。致命的エラーの場合は安全にプロセス終了する。

FR-A-3.3: 正常動作終了時（毎朝9:00前後）には、取得したデータの後処理やリソース解放（APIセッション終了など）を行う。次回実行に備え、メモリや接続をクリーンアップする。

【Component B: Excel監視コックピットの機能要件】

FR-B-1: 銘柄コード入力インターフェース – Excelシート上に、トレーダーが銘柄コードを入力できる領域を用意すること。最大で10銘柄程度を同時監視できるよう行を確保する（例：A列に1行目から10行目まで入力欄）。銘柄コードは原則4桁数字で入力し、市場は東証プライムを前提とする（必要ならシート上で市場補足情報を持つか、RSS関数で市場も指定する）。

FR-B-2: リアルタイムデータ取得 – A列の入力値（銘柄コード）に基づき、楽天RSSの関数を用いて以下の情報をリアルタイムに取得し表示すること（各項目の取得には所定のRSS関数文字列を使用）。取得項目:

現在値（最終取引価格）

始値（当日寄り付き価格）

高値（当日これまでの高値）

安値（当日これまでの安値）

出来高（当日累計出来高）
各データはMarketSpeed IIが提供するリアルタイム値をExcelセル上に更新表示する。例えば、現在値取得には =RSS|"東証\<<銘柄コード>>";"現在値" のような形式を使用（実際のRSS書式は楽天証券のマニュアルに従う）。データは数秒おきに自動更新されるようRSS機能の自動再リクエスト設定
rakuten-sec.co.jp
を有効化する。

FR-B-3: テクニカル指標計算 – 上記取得データを用いて、各銘柄ごとに以下の指標をExcel上でリアルタイム計算・表示すること。可能な限りExcel標準の数式で対応し、難しい場合はVBAマクロを用いてもよい（マクロ使用時は別途FR-B-5で記載）。

アンカードVWAP (AVWAP) – 当日9:00から現在時刻までの出来高加重平均価格を算出する。計算式は「累積(価格×出来高) / 累積出来高」。Excel上でこれを実現するには、1分足もしくはティックデータの累積計算が必要。可能であればRSSのティック取得機能を用い、直近値と出来高増分から算出する。難しければ、例えば始値を基準に現在値・出来高で近似するか、VBAで毎分の値を取り込み計算する方法も検討する。正確なVWAP算出ロジックと実装方法を決定し、ドキュメント化すること。

ATR (アベレージ・トゥルー・レンジ) – 1分足データを基に期間5のATRを算出する。具体的には、当日9:00からの各1分バーごとにTrue Rangeを計算し、直近5本の平均をリアルタイム更新する。RSSで過去の高値・安値が取得できれば計算式で対応可能。難しければ、VBAで1分おきに高値・安値を記録し計算する。初期5分間（9:00～9:04）はデータ不足のためATR算出不可だが、その間は暫定値として出来高や銘柄ボラティリティに応じた推定値を表示するか「--」表示とする（仕様決定事項）。

AVWAPからの乖離率（ATR単位正規化） – 現在値がAVWAPと比べてどれだけ乖離しているかを、ATRを1とした相対値で算出する。計算式例:

乖離率(ATR単位) = (現在値 - AVWAP) / ATR


これにより、異なる銘柄間でも何倍のATRだけ乖離しているかで比較可能になる。プラスの値は現在値がVWAPより上（割高）、マイナスは下（割安）を示す。なおATRが0に近い場合の発散対策も施す（小さすぎるATRの場合は閾値判定を一律有効/無効にする等）。

FR-B-4: シグナル可視化 – 上記リアルタイム指標の中で、エントリーのセットアップ条件を満たした際にトレーダーに直感的に伝える可視化機能を実装する。

FR-B-4.1: シグナル条件の視覚アラート: 「乖離率(ATR単位)の絶対値 |乖離| が 0.6 以上」をシグナル条件（例：±0.6×ATR以上の乖離）とし、これを満たした銘柄行のセル（少なくとも乖離率セル）に条件付き書式で色付けする。具体例:

乖離率 ≥ +0.6 の場合、その銘柄行を赤系のハイライト（過熱＝売り場を示唆）。

乖離率 ≤ -0.6 の場合、青または緑系のハイライト（急落＝買い場を示唆）。
色分けにより直感的に売りシグナルと買いシグナルを区別する。閾値0.6は経験則に基づく初期値で、必要に応じトレーダーが調整できるようシート上でパラメータ化（閾値を入力セルから参照）してもよい。

FR-B-4.2: 売買判断補助情報: シグナル発生時または常時表示として、利確目標価格および損切り基準価格を各銘柄ごとに計算・表示する。計算ロジック例:

利確目標: 現在値がVWAPより上ならVWAP値までの押し戻りを狙った値（＝VWAPそのもの、もしくは現在値から-0.3ATRなど）、現在値がVWAPより下ならVWAPまでの戻りを目標とする。または一律に±0.5ATR幅を利確幅として現在値から算出する方法も考えられる。

損切り基準: エントリーと逆方向に一定幅（例：0.2～0.3ATR）動いた価格を損切り水準とする。例えば売りエントリー想定なら現在値＋0.2ATR、買いなら現在値-0.2ATRなど。
具体的な算出式は戦略のリスク許容度に応じて調整可能だが、本仕様書ではVWAPへの回帰を利確、ATRの一定倍を許容リスクの一例で提示する。最終的な決定はトレーダーと協議の上でExcelシートに実装すること。

FR-B-5: Excelマクロと拡張性 – （必要に応じて追加）上記のリアルタイム計算や自動発注を補助するためにVBAマクロを使用する場合、以下の要件を満たすこと:

FR-B-5.1: マクロを使用する際はセキュリティと安定性に留意する。自動更新マクロ（OnTimeによるタイマー処理等）は、マーケットスピードIIのRSS更新と競合しないよう適切に設計する。無限ループにならないよう終了条件も設ける。

FR-B-5.2: マクロやRSSの設定手順、動作方法については**ユーザー向けドキュメント（後述）**に明記し、ユーザーが正しく有効化できるようにする。

FR-B-5.3: （将来拡張）Excel側で自動発注まで行う場合、楽天RSSの注文用関数（例：RssStockOrder_v 等）を使用しVBAから発注処理を記述できる
e-debugger.xyz
。現段階では実装不要だが、コードの可読性・拡張性を保ち、将来VBAモジュールを追加しやすい構成にしておく。

FR-B-6: ドキュメント整備 – Excelコックピットのユーザーが迷わず扱えるよう、以下を行う:

FR-B-6.1: 利用手順書（ユーザーガイド）の作成: Excelシートの使い方、設定方法、各表示項目の意味、閾値やパラメータの変更方法、注意事項等を記載したドキュメント（例: READMEやマニュアルPDF）を用意する。特に、MarketSpeed II RSSの初期設定やExcelアドイン有効化手順、銘柄コードの入力方法、シグナル発生時の売買判断フロー例など、実運用に直結する情報を書く。

FR-B-6.2: 要件定義と実装仕様の同期: 本変更仕様に基づきExcelシートを構築した後、実際のExcel関数式やマクロについても簡単な技術解説資料を残す（開発者用）。これにより将来の変更や引継ぎが円滑になる。

以上が改訂後の機能要件定義となります。

4. 改訂版 開発タスクリスト

最後に、上記要件を確実に満たすための開発タスク一覧を提示します。Part 1でPythonスクリーナー、Part 2でExcelコックピット、Part 3でドキュメント作成とテストに分け、各工程を順序立てています。各タスクは必要に応じ並行して進めつつ、最終的な結合テスト時に統合される流れを想定します。

Part 1: Python銘柄スクリーナー開発

Task 1.1: 開発環境準備 – Python 3.10以上の環境を構築し、必要ライブラリをインストールする。具体的には:

ライブラリ: pandas, numpy, apscheduler（スケジューラ）, requestsまたは公式のkabuステーションAPIクライアント。

kabuステーションAPIの利用準備: auカブコム証券より発行されたAPIアクセスTOKENを取得し、設定ファイル（例:config.json）に保存。kabuステーション®を起動しAPIが受け付け可能な状態にする。必要に応じてAPIマニュアルを参照し接続テストを行う。

（任意）開発効率向上のためJupyter Notebook等でまず試行し、最終的にスクリプト化する方法も検討。

Task 1.2: APIデータ取得モジュール実装 – kabuステーションAPIから板情報を取得するコードを実装する。

複数銘柄の板情報取得用に関数（例えば fetch_board_data(symbols)）を用意し、一度に複数銘柄を取得できるなら活用。無い場合は1銘柄ずつ取得し結果をまとめる。

API制限に配慮し、スリープや非同期処理を組み合わせて1秒あたりのリクエスト数を調整する
how-to-make-stock-trading-system.dogwood008.com
。例えば、Pythonのasyncioやスレッドプールを使い同時並列で最大10リクエスト/秒を実現しつつ、超過しない制御を行う。

テスト: 東証プライムの一部銘柄（10銘柄程度）で板情報取得を試し、正常にデータ（買気配・売気配値と数量等）がパースできるか確認。想定外のデータ（特別気配など）の扱いも検証する。

Task 1.3: 銘柄選定ロジック実装 – FR-A-2に従い、AOI計算と条件判定を行うコードを実装。

ループ処理: 8:55から指定時刻まで、Task1.2の取得関数を用いて全対象銘柄のデータを繰り返し取得。取得データから各銘柄のAOIを計算し、リストや辞書構造に銘柄別AOIの時系列を蓄積する。

安定性評価: 取得ループ終了後、蓄積したAOI時系列から標準偏差を算出。各銘柄の最新AOI値と標準偏差を対で保持。

フィルタリング: 上記データから条件 |AOI| ≥ 0.4 を満たす銘柄を抽出し、更に標準偏差が閾値以下のものに絞り込む。閾値設定は初期的には経験則で例えば0.1（AOIが一貫して同符号で推移）などとし、必要に応じ設定ファイル等で調整可能にする。

出力用リスト生成: 抽出銘柄についてコードをリスト化。必要に応じリストをソート（例：|AOI|降順）し、上位N件に絞る処理を入れる。0件だった場合の処理も実装。

テスト: ロジック単体テストとして、仮想的にAOI値を生成したデータ（極端にAOIが高いケース等）で動作確認する。また過去日の8:55板情報を少数銘柄で取得し、既知の正解と照合するテストを行う。

Task 1.4: スクリプト完成・スケジューリング – メイン関数を作成し、上記機能を組み合わせて動作するようにする。

スケジューラ設定: APScheduler を用いて毎営業日8:55に main() が走るようスケジュール登録。システム起動時にスケジューラ開始するコードを含める。※開発中は手動実行でテスト、本番運用時にスケジューラ有効化。

出力処理: 8:59:50に抽出した銘柄リストを print() でコンソール表示し、同時にテキストファイルにも保存する（Pythonのファイル操作で書き込み）。保存先はプロジェクトフォルダ内の watchlist.txt とし、Excelが参照しやすいパスにする。既存ファイルがあれば上書き。

ログ記録: ログ用にloggingモジュール等でINFOレベルログを出力する（起動時刻、取得銘柄数、抽出結果、処理時間など）。エラーはERRORレベルで記録。

終了処理: 全工程終了後（9:00前後）に sys.exit(0) などで安全にプログラムを終了させる。終了前にAPI接続のクローズ処理（不要なら省略）や終了ログを書き込む。

実機テスト: 実際の営業日の朝に近い環境でスクリプトを動かし、想定通りリストが出力されるか検証する。API制限に引っかからず短時間で処理できるか、必要なら最適化調整。

Part 2: Excel監視コックピット作成

Task 2.1: シートレイアウト設計 – Excelワークブックを新規作成し、監視コックピット用のシート（例えば"ScreenerDashboard"シート）を設計する。

列構成を決定: A列に銘柄コード、B列に銘柄名（必要ならRSSで取得可能）、C列以降に 現在値, 始値, 高値, 安値, 出来高, AVWAP, ATR(5), 乖離率, 利確目標, 損切目安 といった項目列を配置する。列見出し行を1行目に固定し、2行目以降に各銘柄のデータが入るようにする。

行はとりあえず10行程度用意（将来的に増減可能）。視認性を高めるため、見出し行は太字や色付け、銘柄行は奇数行・偶数行で背景色を薄く変える等フォーマット調整を行う。

列幅や表示形式（小数点桁など）も適切に設定。価格は0または1桁小数、乖離率は小数点2桁程度、利確/損切価格は0桁で表示など。条件付き書式で色が変わる箇所は、通常時は目立たないデザインに。

（確認）監視に不要な項目や冗長な情報は極力省き、一目で異常値がわかるシンプルなレイアウトを心がける。

Task 2.2: RSS関数によるリアルタイムデータ埋め込み – MarketSpeed IIのRSSアドイン機能を用いて、Task2.1で決めた各データ項目セルにRSS関数を入力する。

まずMarketSpeed IIを起動しログイン、Excelの「楽天RSS」アドインが有効になっていることを確認（準備手順は楽天証券のマニュアル参照）。

A列の銘柄コードを参照しつつ、例えば現在値取得であればB列のセル（2行目以降）に =RSS|"東証\:" & $A2; "現在値" のような式を入力する（実際の書式に応じ調整。のサンプルシート等も参考）。始値、高値等も同様に適切なフィールド名を指定してRSS関数を記述。

セル参照を活用し、10行分まとめて式をコピーすれば効率的に設定可能。必要に応じて数式入力エディタを使い、一括設定や参照置換を行う
e-debugger.xyz
。

RSSの自動更新間隔設定を確認し、リアルタイム性を確保（通常数秒周期で更新されるはず）。テストとしてマーケット営業時間中にいくつか銘柄コードを入れて値が動くか確認する。

（注）楽天RSSではExcelがアクティブでないと更新が止まる設定があるため、運用時はExcelウィンドウを開いた状態にしておく必要がある点を留意事項とする。

Task 2.3: テクニカル指標のExcel計算式実装 – FR-B-3で定義した各指標をExcel上で計算する。可能な限り関数とセル参照のみで実装し、難しい部分はVBAで補完。

AVWAP計算式: 例えば、現在値セルと出来高セルが取得できる前提で、AVWAPセルには「(始値×始値時点出来高 + 現在値×現出来高 - （逐次の積算）) / 現在の累積出来高」のような式を入れることも考えられる。しかしExcel関数だけで累積を追うのは難しいため、VBAで分足取得する実装も検討する。まずは簡易実装として「(始値 + 現在値) / 2」などで近似し、後で精度向上を図るステップを計画する。

ATR計算式: ATRはExcelの配列数式やテクニカル関数（もしRSS提供があれば）を利用できるか調査する
rakuten-sec.co.jp
e-debugger.xyz
。なければ、例えば別シートに1分足のHigh/Lowを記録し、それを参照してATRを計算する方法も検討。まずは疑似的に「（高値-安値）の現在値に一定係数をかけた値」を表示するなどプレースホルダーを置き、後でVBA組み込み含め実装。

乖離率計算式: こちらは単純に「=(現在値セル - AVWAPセル) / ATRセル」とExcel数式で記述する。Excel上での除算におけるゼロ除算エラーを防ぐため、IFERROR関数でATRセルが0または未計算なら空白/ハイフン表示するよう工夫する。

利確・損切計算式: 乖離率とATRから算出する場合、例えば利確セルに =IF(乖離率セル>0, AVWAPセル, AVWAPセル) （VWAP自体を目標にする例）や =現在値セル - SIGN(乖離率セル)*0.5*ATRセル （現在値から±0.5ATR）等の式を入れる。損切セルもSIGN関数を使い逆方向に0.2ATRずらす等で計算。最終的なロジックは要件に基づき決定し、Excelに実装する。

各計算セルを適切な書式（価格は円、乖離は数値+単位等）で表示させ、異常値（DIV/0エラー等）が出ないよう関数でガードする。

上記Excel計算式の妥当性を、市場が動いている時間にテストする。例えばAVWAPが始値と現在値の中間値付近になるか、乖離率が大きい時に手計算と合うかなど確認する。必要なら調整やVBA導入判断を行う。

Task 2.4: 条件付き書式と視覚警報設定 – シグナル可視化のためExcelの条件付き書式機能を設定する。

乖離率セルの範囲（例えばシート上H2:H11が乖離率）を選択し、新しい条件付き書式ルールを追加。「数式が」のタイプで、=ABS($H2)>=0.6 を条件式とする。書式は塗りつぶし（背景）を濃い黄色等に設定し点滅は手動では難しいため、代替としてフォント色も反転させる等視認性を高める工夫をする。必要に応じ+0.6と-0.6で別ルールにして色を変える（赤/青）。

ルールを各行に適用する際、セル番地がずれないよう絶対参照/相対参照を慎重に設定する（上記例は行は相対、列固定）。

利確・損切目安セルについては条件付き書式は不要だが、現在値との差がわかりやすいように、例えばセルにアイコンセット（上矢印/下矢印）を表示する、もしくは単純にセルに「▲」「▼」記号を付けるなど工夫することもできる。

設定後、条件を満たす仮の値を入れて色変化をテストし、期待通りハイライトされることを確認する。

Task 2.5: 自動化・連携の検討（省力化オプション） – 手動での銘柄コード入力をよりスムーズにするためのオプション対応。

Pythonで出力したwatchlist.txtをExcelが自動取り込めるように、Excelに**クエリ（データ取り込み機能）**を設定し、テキストファイルからA列にデータを流し込む仕組みを試す。Excelの「データ取り込み」でテキストをリンクし、更新ボタンで取り込む方法などがある。

あるいは簡易的に、トレーダーがコピーする手間を減らすため、Pythonの最終出力時にWindowsクリップボードに銘柄をコピーする（pyperclip等利用）仕組みも考えられる。これは必須ではないが、ユーザー体験向上として可能なら実装。

上記は時間に余裕があれば対応し、基本は既定通り手動入力でも運用可能とする。自動化した場合も動作テストを十分に行う。

Part 3: ドキュメンテーションとテスト

Task 3.1: システム結合テスト – Pythonスクリーナー（Part1）とExcelコックピット（Part2）を連携させた総合テストを行う。

前日や休日の板情報を擬似入力してPythonを実行し、疑似的な銘柄リストをExcelに流すことで、Excel側の反応（計算・色付け）が期待通りになるか確認する。

実際のマーケット時間中（9:00～9:15）に、Pythonで過去に検出した銘柄をExcelに入れてみて、指標計算やシグナル表示の整合性を検証する。

API部分とRSS部分のデータ齟齬がないかチェック。例：8:59の板情報で条件ギリギリ通過した銘柄が、9:00の実際始値でどう動くか。Excelでの乖離判定が戦略意図にマッチしているか評価し、必要なら閾値調整やロジック修正をフィードバックする。

エラーケーステスト: Pythonで意図的にAPIを止めて再接続を試す、Excelで銘柄コードを誤入力した場合（存在しないコード等）にエラー表示されないか、なども確認する。

Task 3.2: ドキュメント作成（ユーザー向け） – FR-B-6に従い、操作手順書やREADMEを整備する。

Pythonスクリーナーの簡単な使い方（自動起動設定方法、ログの見方、想定動作）も含めてまとめる。

Excelコックピットについて、初回セットアップ手順（RSSアドイン有効化、マーケットスピードのログイン手順）、日々の使用手順（毎朝のファイル更新手順、銘柄コピー方法）、シグナルの意味とトレード判断例、注意事項（Excelを閉じない、PC時刻の正確さ、ネットワーク接続保持等）を記載する。

可能なら画面キャプチャを貼り付け、シグナル点灯時の例など視覚的に示すと理解しやすい。Markdown形式のREADME.mdか、社内Wikiページ、もしくはPDFマニュアルなど形式は問わないが、ユーザー（一人開発者である質問者本人含む）が後で見返して使える内容にする。

Task 3.3: 保守計画と今後の拡張メモ – 開発完了後、今後想定される機能拡張（自動発注の実装方法検討、監視対象の拡大、他戦略への転用など）について簡単に展望をまとめておく。これは正式ドキュメントではなく開発者のメモ的な位置付けだが、例えば:

自動発注を行う場合は、PythonからauカブコムAPI経由で発注するか、Excel VBAで楽天RSSの発注関数を使うか、それぞれメリットを整理。

パフォーマンス改善策のアイデア（より高速なデータ取得方法、銘柄数増加時の対応など）。

これらを簡潔に文章化し、次のバージョンアップ時に役立てる。

3) 最終仕様（要件定義／設計指示：修正版）
3.1 アーキテクチャ（最終）

A: Python スクリーナー（寄り前）

08:45–08:54 静的一次絞り込み（ランキングAPI活用）

08:55–08:59:50 二段階スキャン（PUSH＋バッチ50）

08:59:50 までに最大10銘柄を watchlist.txt で出力

B: Excel コックピット（寄り後～9:15）

起動時に watchlist.txt 自動読込（VBA）

RssChart(1M) で分足更新、AVWAP（=当日VWAP）/ATR(5,1M) 算出

乖離( (Last-AVWAP)/ATR ) の条件付き書式でアラート

将来：VBA発注API呼出のスイッチ追加（初期はOFF）

制約明文化：情報系10req/s、登録上限50、PUSH対象=登録銘柄のみ。
GitHub
+1

3.2 データ仕様・指標

AOI（Auction Order Imbalance 近似）
AOI = (BidQty - AskQty) / (BidQty + AskQty)、寄り前は最良気配の数量で代替。
フォールバック：BidQty/AskQty が欠落 or 特別気配 → 当該サンプル無効（時系列の有効点が閾値未満なら銘柄除外）。
GitHub

寄付予想の利用
CalcPrice を寄付予想の近似として参照（IOPの代理）。乖離の重み付け等のスコアに利用。
kabucom.github.io

安定性（見せ板対策）
8:55–9:00で収集したAOIの標準偏差。σ_AOI ≤ 0.10 を通過条件（設定で可変）。

Excel側

AVWAP：当日9:00からのVWAP（RssChart 1分足の累積で厳密算出。RSS提供VWAPがある場合は検証の上採用可）。
Qiita
+1

ATR(5)：True Rangeを1分足で更新し直近5本の平均。

乖離(ATR単位)：(Last - AVWAP)/ATR（IFERROR 防御）。

アラート：|乖離| ≥ 0.6 で着色（+側=赤：売り候補、-側=緑：買い候補）。閾値セルで調整可能。

3.3 スクリーニング・フロー（確定）

Stage 0（08:45）

kabuAPI ランキングで東証プライム上位を一括取得（売買代金/出来高/急増など）→ 約200銘柄に絞る。
Go Packages

Stage 1（08:55–）AOI時系列の取得

200銘柄を4バッチ×50に分割。

各バッチで

/unregister/all → /register（50銘柄）

WebSocket PUSHで約55–60秒AOIを収集

σ_AOI 算出・一時スコア付け

これをローテーション（50×4=200、総計~4分で全走査）。
RubyDoc
+2
Qiita
+2

Stage 2（08:59:30）最終選定

フィルタ：|AOI| ≥ 0.40 かつ σ_AOI ≤ 0.10（欠測が一定超なら除外）

タイブレーク：|CalcPrice - PrevClose|/PrevClose の大きさ、当日イベントフラグ等

上位最大10銘柄を watchlist.txt に保存（銘柄コードのみ / 改行区切り）

Stage 3（09:00–09:15）Excel監視

watchlist.txt 自動取込 → RssChart(1M) 起動 → AVWAP/ATR/乖離を更新

ルール通り（±0.6ATR乖離＋反転足確認 etc.）で裁量エントリー

9:15強制クローズは運用ルール（システム時刻をNTP同期）

3.4 自動発注の拡張余地（非同時実装）

Excel側：RssMarginOpenOrder_v / RssStockOrder_v をアラートON時のみ有効化（既定OFF、確認ダイアログ有）。
MarketSpeed

Python側：将来はkabuAPI発注（/sendorder）に切替可能。FAS/FAK/FOK等の組合せはAPI仕様に準拠。
GitHub

3.5 可用性・運用

営業日判定（非営業日は即終了）

ログ：AOIサマリ、バッチ切替時刻、登録/解除レスポンス、欠測件数、最終選定理由

エラーハンドリング：429/一時障害は指数バックオフ、欠測時は銘柄スキップ

時刻同期：NTP必須（9:00境界ズレ回避）

4) 最終タスクリスト（優先度・完了条件付き）
Part A：Python（寄り前スクリーナー）

A1【必須・高】ランキング一次抽出

kabuAPIのランキング取得（売買代金/出来高/急増）→約200銘柄

Done：200±20銘柄/日で取得安定（<1s）

A2【必須・高】PUSH基盤＋登録管理

/unregister/all→/register(≤50) のバッチ制御、WebSocket購読

Done：50銘柄×約60秒×4巡が8:59:30以内に完了、欠測率<5% 
kabucom.github.io
+1

A3【必須・高】AOI/安定性算出

AOI= (BidQty-AskQty)/(BidQty+AskQty)、欠測は捨象。σ_AOI算出

Done：欠測時の耐性（NULL/特別気配）をログで確認 
GitHub

A4【必須・中】最終選定と出力

条件：|AOI|≥0.40 & σ≤0.10、同率はCalcPrice乖離大を優先

Done：watchlist.txt（改行区切り）を8:59:50までに生成

A5【必須・中】営業日・ログ・設定

祝日カレンダー or JPX営業日ロジック、logging整備、.env/config.json

Done：INFOログにバッチ時刻と最終選定理由が残る

Part B：Excel（寄り後ダッシュボード）

B1【必須・高】自動読込VBA

起動時 watchlist.txt をA列に投入、エラー時はメッセージ

B2【必須・高】RssChart(1M) 配線

各銘柄の1分足を非表示シートへ流し込み（最大15本でOK）

Done：分足が毎分自動追随（9:00直後の初期化含む）
Qiita

B3【必須・高】AVWAP/ATR(5) 計算

AVWAP=∑(価格×出来高)/∑出来高（当日分足累積）

ATR=TR(当該1分)の5本平均（初期5本は“--”表示）

B4【必須・中】乖離アラート & 目安価格

乖離≥+0.6：赤、≤-0.6：緑。閾値はセルで可変

目安：利確=AVWAP、損切=±0.2–0.3ATR（セル計算）

B5【将来・低】VBA発注スイッチ

RssMarginOpenOrder_v雛形と確認ダイアログ

既定OFF、設定セルでONのみ発注可 
MarketSpeed

Part C：テスト／受入

C1：朝リハーサル（リアル相場で3日）

8:59:50出力達成率100%、Excel自動読込成功率100%

C2：欠測耐性

特別気配・NULL混入日の処理継続（スキップ動作）をログで確認 
GitHub

C3：レイテンシ

8:55開始→全バッチ収集完了< 4分、CPU/ネット負荷の監視

C4：ユーザー手順書

初回セットアップ、毎朝の起動手順、閾値調整、トラブル時FAQ

実装メモ（設計に直接効く要点）

API上限：情報系10req/s、登録は50まで、RESTでも登録にカウント。
GitHub

登録制御：/unregister/all で毎バッチ頭を空にしてから /register。
RubyDoc
+1

PUSH：ws://localhost:18080/kabusapi/websocket（kabuステ起動必須）。フィールドにVWAP/BidQty/AskQty/CalcPriceあり。
kabucom.github.io

Excel：RssChart( ,銘柄, "1M", 本数)、VBAでAVWAP/ATR更新。VBA発注関数は公式マニュアルに列挙。
Qiita
+1

寄り前の市場事情：板寄せ・特別気配で値が止まる／欠測あり、AOIは堅牢に。
Japan Exchange Group


改訂サマリ（何を直すか）

API制約遵守の実装へ
　- 一次抽出はランキングAPIで200銘柄内に絞る。
　- 50銘柄×バッチで /register→WebSocket PUSH→ AOI収集 → /unregister/all をローテーション。
　- RESTポーリングは最小化、PUSH主体で秒間上限を回避。 
Mitsubishi UFJ e-Smart Securities
+1

Excelの指標計算を安定化
　- RssChart(“1M”)で分足を非表示シートにスピル取得。
　- VBAは「watchlist読込＋毎分の再計算トリガ」に限定し、AVWAP/VWAP・ATR(5) はRssChart出力に対する数式で算出（列マッピングを固定）。 
marketspeed.jp
+1

データ品質ルールを追加
　- AOI計算は欠測サンプルを無効化。
　- **有効サンプル数の下限（例：≥8点）**を満たさない銘柄は除外（特別気配・NULL耐性）。 
kabucom.github.io

Codex への差分指示（コピペ可）
1) 選定ロジック：有効サンプル下限を導入

src/asagake/screener.py を差し替え／更新：

from __future__ import annotations
from dataclasses import dataclass
from typing import Dict, List, Callable, Optional, Tuple
import math
from .aoi import compute_aoi_series, summarize_aoi

@dataclass
class SelectionParams:
    min_abs_aoi: float = 0.40
    max_sigma: float = 0.10
    top_k: int = 10
    min_samples: int = 8   # ← 追加：有効AOIサンプルの下限

def select_symbols(
    aoi_inputs: Dict[str, Tuple[list[float], list[float]]],
    params: SelectionParams,
    tie_break_score: Optional[Callable[[str], float]] = None,
) -> List[str]:
    scored: List[tuple[str, float, float]] = []
    for sym, (bid_list, ask_list) in aoi_inputs.items():
        series = compute_aoi_series(bid_list, ask_list)
        if len(series) < params.min_samples:
            continue  # 欠測耐性：有効点が少ない銘柄は除外
        m = summarize_aoi(series)
        if math.isnan(m.latest) or math.isnan(m.sigma):
            continue
        if abs(m.latest) < params.min_abs_aoi or m.sigma > params.max_sigma:
            continue
        base = abs(m.latest)
        bonus = tie_break_score(sym) if tie_break_score else 0.0
        scored.append((sym, base, bonus))
    scored.sort(key=lambda x: (x[1], x[2]), reverse=True)
    return [s for s, _, _ in scored[: params.top_k]]


tests/test_selection.py を追記：

from asagake.screener import select_symbols, SelectionParams

def test_excludes_when_samples_below_min():
    inputs = {
        "A": ([100,110],[80,90]),   # 2点 → 除外
        "B": ([120]*10,[60]*10),    # 10点 → 通過
    }
    p = SelectionParams(min_abs_aoi=0.2, max_sigma=1.0, top_k=10, min_samples=8)
    sel = select_symbols(inputs, p)
    assert "A" not in sel and "B" in sel

2) バッチ設計（50銘柄ずつ）とTDDの足場

src/asagake/schedule.py 新規：

from typing import List

def plan_batches(symbols: List[str], batch_size: int = 50) -> List[List[str]]:
    return [symbols[i:i+batch_size] for i in range(0, len(symbols), batch_size)]


tests/test_schedule.py 新規：

from asagake.schedule import plan_batches

def test_plan_batches_50():
    syms = [f"{i:04d}" for i in range(200)]
    batches = plan_batches(syms, 50)
    assert len(batches) == 4
    assert all(len(b) <= 50 for b in batches)
    assert batches[0][0] == "0000" and batches[-1][-1] == "0199"

3) プロバイダ切替（mock/kabu）— run_screener を拡張

scripts/run_screener.py を更新（--provider 追加）：

from asagake.providers.mock import MockProvider
try:
    from asagake.providers.kabu import KabuProvider
except Exception:
    KabuProvider = None

# ...
parser.add_argument("--provider", choices=["mock","kabu"], default="mock")
# ...
prov = MockProvider() if args.provider=="mock" or KabuProvider is None else KabuProvider()


kabuProvider はAPI開通後に実装。現時点は mock でTDDを前進。
kabu側はランキング→50銘柄登録→WebSocket PUSH→解除のローテ設計に（公式：登録最大50・PUSH配信対象は登録銘柄）。 
kabucom.github.io

4) kabu Provider の骨格にコメントで制約を明記

src/asagake/providers/kabu.py（スタブに制約コメントを追記）：

# NOTE: kabu API 制約
# - 情報系/登録APIは 10 req/sec 上限（FAQ）
# - PUSHは /kabusapi/websocket 。配信対象は REST「銘柄登録」済みのみ、最大50銘柄
# - 寄り前は最良気配が欠損/特別気配あり → 欠測は無効サンプルとして扱う
# 実装方針：
# 1) ランキングAPIで ~200銘柄に一次抽出（軽量）
# 2) 50銘柄×バッチ：/unregister/all → /register(≤50) → PUSHで約60秒収集 → 次バッチ
# 3) 約4分で全200銘柄のAOI時系列を確保


テスト実行＆コミット

pytest -q
git add .
git commit -m "feat: min_samples gate, batch planner, provider switch; tests green"

Excel コックピット：役割分担を明文化（RssChart ベース）
配置（必須）

Settings

B2：watchlist.txt の絶対パス

B3：乖離しきい値（0.6 初期）

Dashboard（A2:A11に銘柄コードが自動投入）

C 現在値 =RssMarket($A2,"現在値")

D 始値 =RssMarket($A2,"始値") など単項目は RssMarket 系

Bars（非表示可）

各行の銘柄ごとに RssChart を12列幅でブロック配置

例）Bars!B2 に
=RssChart(1, Dashboard!$A2, "1M", 20)
→ ヘッダ＋20本分の「日付/時刻/始/高/安/終/出来高」スピル（公式仕様） 
marketspeed.jp
+1

計算（数式で完結）

AVWAP (=当日VWAP)（Dashboard!H2）：
例：Barsのブロック先頭を B2 とし、データ列を固定した上で当日分だけ集計

=LET(
  blk, Bars!B3:K22,
  d,  INDEX(blk,,4),   /* 日付 */
  c,  INDEX(blk,,9),   /* 終値 */
  v,  INDEX(blk,,10),  /* 出来高 */
  rows, FILTER(blk, d=TODAY()),
  IF(SUM(INDEX(rows,,10))>0,
     SUM(INDEX(rows,,9)*INDEX(rows,,10))/SUM(INDEX(rows,,10)),
     "")
)


※列番号は RssChartの出力仕様に合わせて調整（上は代表例）。 
marketspeed.jp

ATR(5, 1分足)（Dashboard!I2）：
TrueRange を当日分から計算し直近5本の平均（動的配列でOK）。

=LET(
  blk, Bars!B3:K22,
  rows, FILTER(blk, INDEX(blk,,4)=TODAY()),
  H, INDEX(rows,,7), L, INDEX(rows,,8), C, INDEX(rows,,9),
  Prev, VSTACK(NA(), TAKE(C, ROWS(C)-1)),
  TR, BYROW(SEQUENCE(ROWS(C)), LAMBDA(r, MAX(H[r]-L[r], ABS(H[r]-Prev[r]), ABS(L[r]-Prev[r])))),
  IF(ROWS(TR)>=5, AVERAGE(TAKE(TR,5*-1)),"")
)


乖離(ATR単位)（Dashboard!J2）：
=IFERROR( (C2 - H2) / I2 , "" )

条件付き書式（Dashboard!J2:J11）：
=ABS(J2)>=Settings!$B$3 → +側=赤 / -側=緑 の2ルール

これでVBAは「watchlist読込＆毎分OnTime起動」だけに縮小。計算はRssChart出力×数式で安定運用。 
marketspeed.jp

監査指摘への回答（妥当性と修正の要約）

API制約の無視 → 是正：ランキング→50銘柄×PUSHローテの設計へ更新。FAQ/Push仕様の上限に完全準拠。 
kabucom.github.io
+1

Excel指標計算の曖昧さ → 是正：RssChartスピルを唯一のデータ源に固定。AVWAP/ATRは式で確定的に算出。 
marketspeed.jp

現実データの欠損対応不足 → 是正：min_samplesゲートで有効点不足を除外（特別気配・NULL耐性）。PUSHの欠配も吸収。 
kabucom.github.io

次アクション（あなた向け）

上記差分をCodexへ貼付→ファイル更新。

pytest -q → Green を確認 → コミット/プッシュ。

Excelは RssChart を指示通り配置（列マッピングはPDF仕様で確認）。 
marketspeed.jp

kabuAPI開通後：KabuProvider実装（ランキング→バッチ登録→PUSH収集）を着手。

これで、API制約に準拠し、Excel計算も安定する実装線に乗りました。